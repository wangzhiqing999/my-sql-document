<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=GBK" />
  <title> 分区表 - RANGE分区-初期分区定义  </title>
  <link href="Common.css" rel="stylesheet" type="text/css" />
</head>

<body>


<h1> 分区表 </h1>


<h2> RANGE分区-初期分区定义  </h2>



这里以一个 销售 的业务来做测试
销售表有 日期 / 商品 / 销售额 三个字段
测试数据从 2010年1月1日 至 2010年9月31日
以“月”为单位进行分区


要求创建分区表或分区索引的步骤
1. 确定分区列和分区数
   分区列为 日期，分区单位为月
   初次创建时，需要创建 10 个分区

2. 确定是否使用多个文件组
   使用





<table border="1" style="width:100%">

  <tr>
    <td> Oracle </td>
    <td>
<pre><code>

创建分区表， 按照 每个月 的方式分区。

SQL> CREATE TABLE sale_data (
  2    sale_date  DATE NOT NULL,
  3    sale_item  VARCHAR(2) NOT NULL ,
  4    sale_money DECIMAL(10,2) NOT NULL
  5  )
  6  PARTITION BY RANGE (sale_date) (
  7    PARTITION p201001 VALUES LESS THAN (TO_DATE('20100201', 'YYYYMMDD')),
  8    PARTITION p201002 VALUES LESS THAN (TO_DATE('20100301', 'YYYYMMDD')),
  9    PARTITION p201003 VALUES LESS THAN (TO_DATE('20100401', 'YYYYMMDD')),
 10    PARTITION p201004 VALUES LESS THAN (TO_DATE('20100501', 'YYYYMMDD')),
 11    PARTITION p201005 VALUES LESS THAN (TO_DATE('20100601', 'YYYYMMDD')),
 12    PARTITION p201006 VALUES LESS THAN (TO_DATE('20100701', 'YYYYMMDD')),
 13    PARTITION p201007 VALUES LESS THAN (TO_DATE('20100801', 'YYYYMMDD')),
 14    PARTITION p201008 VALUES LESS THAN (TO_DATE('20100901', 'YYYYMMDD')),
 15    PARTITION p201009 VALUES LESS THAN (TO_DATE('20101001', 'YYYYMMDD'))
 16  );

表已创建。

</code></pre>
    </td>
  </tr>





  <tr>
    <td> DB2 </td>
    <td>
<pre><code>


</code></pre>
    </td>
  </tr>





  <tr>
    <td> SQL Server </td>
    <td>
<pre><code>

创建分区函数
CREATE PARTITION FUNCTION sale_date_part_func(DATETIME)
AS RANGE RIGHT FOR VALUES(
    CONVERT(DATETIME, '2010-01-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-02-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-03-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-04-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-05-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-06-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-07-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-08-01 00:00:00', 120),
    CONVERT(DATETIME, '2010-09-01 00:00:00', 120)
);
go


创建分区架构（Schema）
CREATE PARTITION SCHEME sale_date_part_sche
AS PARTITION sale_date_part_func
TO (
  [PRIMARY], [PRIMARY], [PRIMARY],
  [PRIMARY], [PRIMARY], [PRIMARY],
  [PRIMARY], [PRIMARY], [PRIMARY],
  [PRIMARY]
);
go


创建分区表
CREATE TABLE sale_data (
  sale_date  DATETIME NOT NULL ,
  sale_item  VARCHAR(2) NOT NULL ,
  sale_money DECIMAL(10,2) NOT NULL
) ON sale_date_part_sche(sale_date);
go


</code></pre>
    </td>
  </tr>





  <tr>
    <td> MySQL</td>
    <td>
<pre><code>

首先需要查看，当前数据库是否支持分区

mysql>SHOW VARIABLES LIKE '%partition%';
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| have_partitioning | YES   |
+-------------------+-------+
1 row in set (0.03 sec)


创建分区表， 按照 年月 的方式分区。
mysql> CREATE TABLE sale_data (
    ->   sale_date  DATETIME NOT NULL,
    ->   sale_item  VARCHAR(2) NOT NULL ,
    ->   sale_money DECIMAL(10,2) NOT NULL
    -> )
    -> PARTITION BY RANGE (YEAR(sale_date)*100+MONTH(sale_date)) (
    ->   PARTITION p201001 VALUES LESS THAN (201002),
    ->   PARTITION p201002 VALUES LESS THAN (201003),
    ->   PARTITION p201003 VALUES LESS THAN (201004),
    ->   PARTITION p201004 VALUES LESS THAN (201005),
    ->   PARTITION p201005 VALUES LESS THAN (201006),
    ->   PARTITION p201006 VALUES LESS THAN (201007),
    ->   PARTITION p201007 VALUES LESS THAN (201008),
    ->   PARTITION p201008 VALUES LESS THAN (201009),
    ->   PARTITION p201009 VALUES LESS THAN (201010)
    -> );
Query OK, 0 rows affected (0.20 sec)

</code></pre>
    </td>
  </tr>






  <tr>
    <td> SQLite </td>
    <td>
<pre><code>


</code></pre>
    </td>
  </tr>



  <tr>
    <td> PostgreSQL </td>
    <td>
<pre><code>





</code></pre>
    </td>
  </tr>







  <tr>
    <td> MongoDB </td>
    <td>
<pre><code>

MongoDB 的分区不叫 分区, 叫做 分片.

处理机制与 关系型数据库有一定的差异.
关系型数据库, 一个分区, 仅仅是一个文件而已.

而 MongoDB 的分片, 实际上是一台服务器.




<hr/> 


本文档为在  Windows / CentOS 下， 配置1个  mongos 服务， 3个 mongoDB 分片的操作。




系统环境

三台 CentOS 虚拟机， 用于担当 “片”  机器名称分别为
 MyCentOS_01    (192.168.253.206)
 MyCentOS_02    (192.168.253.207)  
 MyCentOS_03    (192.168.253.208)


一台 Windows 主机 （192.168.253.78）， 用于担当  “配置服务器”



步骤1.  启动配置服务器.

Windows 机器上，  下载  mongodb-win32-x86_64-2.4.6.zip
解压缩到 D: 盘
修改目录名为  mongodb

D: 盘下面， 创建一个 D:\data\db 目录
然后进入  D:\mongodb\bin 目录
运行
mongod.exe  --dbpath  D:\data\db 
启动配置服务器

 

步骤2. 启动 mongos 进程
Windows 机器上
进入 D:\mongodb\bin 目录
运行 
mongos  --port 30000  --configdb  192.168.253.78:27017
启动 mongos 进程

（
注意事项：  
1.运行 mongos , 必须要指定  --configdb 参数， 这个参数意思是 指定 配置服务器的地址 
2.  --configdb 参数, 后面需要写 具体的机器名称，或者 ip地址，不要使用 localhost
）



步骤3. 启动片
在三台 CentOS  虚拟机上面, 分别运行
mkdir -p  /data/sdb
创建用于存储数据库文件的目录

运行
./mongod --dbpath  /data/sdb
启动 mongo 服务器端程序




步骤4. 添加片
在 Windows 机器上
进入 D:\mongodb\bin 目录
运行 
mongo.exe  192.168.253.78:30000/admin
运行 mongo 客户端， 连接到 mongos

（
注意事项：
这里的端口， 是 mongos 的端口， 不要写成 配置服务器的端口
）



在 mongo 客户端中， 输入命令
db.runCommand({addshard : "192.168.253.206:27017"})
新增一个片
系统返回：
{ "shardAdded" : "shard0000", "ok" : 1 }

运行
db.runCommand({addshard : "192.168.253.207:27017"})
新增一个片
系统返回：
{ "shardAdded" : "shard0001", "ok" : 1 }

运行
db.runCommand({addshard : "192.168.253.208:27017"})
新增一个片
系统返回：
{ "shardAdded" : "shard0002", "ok" : 1 }


上面是把 3 个数据库分片，加入了 mongos 管理

下面是 数据库与表 的配置


运行
db.runCommand({"enableSharding" : "test"})
对数据库 test 启用 分片
系统返回：
{ "ok" : 1 }


运行
db.runCommand({"shardCollection" : "test.TestBasic",  "key" : {"_id" : 1}  })
对数据库  test  下面的  TestBasic  表， 启用分片
按照 _id  列进行分片
系统返回：
{ "collectionsharded" : "test.TestBasic", "ok" : 1 }



步骤5. 管理分片

在mongo 客户端中， 输入命令


mongos> use config
switched to db config


查询所有的 片
mongos> db.shards.find()
{ "_id" : "shard0000", "host" : "192.168.253.206:27017" }
{ "_id" : "shard0001", "host" : "192.168.253.207:27017" }
{ "_id" : "shard0002", "host" : "192.168.253.208:27017" }


查询有分片管理的数据库
mongos> db.databases.find()
{ "_id" : "admin", "partitioned" : false, "primary" : "config" }
{ "_id" : "test", "partitioned" : true, "primary" : "shard0000" }



步骤6. C# 客户端访问的代码

           // mongoDB 的 mongos 运行在 192.168.253.78:30000 端口上.
            // mongoDB 的3个片 安装在 mongo01 / mongo02 / mongo03  这3台虚拟机上.

            // 因为分片对 最终客户端， 是不可见的。
            // 因此这里的 连接字符串， 仅仅包含 mongos 的地址信息.

            string connectionString = "mongodb://192.168.253.78:30000" ;
            MongoClient client = new MongoClient(connectionString);



步骤7.   客户端 发出 数据更新请求后， 服务器数据核对

mongos> use test
switched to db test


mongos> db.TestBasic.count()
103528

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("5254db974639fb9cf61d028a")
}
  shards:
        {  "_id" : "shard0000",  "host" : "192.168.253.206:27017" }
        {  "_id" : "shard0001",  "host" : "192.168.253.207:27017" }
        {  "_id" : "shard0002",  "host" : "192.168.253.208:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "shard0000" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                shard0001       1
                                shard0000       1
                                shard0002       1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
25502d970da9a1b682c9357") } on : shard0001 Timestamp(2, 0)
                        { "_id" : ObjectId("525502d970da9a1b682c9357") } -->> {
"_id" : ObjectId("5255066470da9a1ad86d8dd7") } on : shard0000 Timestamp(3, 1)
                        { "_id" : ObjectId("5255066470da9a1ad86d8dd7") } -->> {
"_id" : { "$maxKey" : 1 } } on : shard0002 Timestamp(3, 0)





<hr/>

本文档为在  Windows / CentOS 下
配置1个  mongos 服务， 
多个 mongoDB 分片的操作。

具体操作为：
新增分片1，插入数据，
新增分片2，插入数据，
新增分片3，插入数据，
新增分片4，插入数据，
移除分片2，新增分片5 的处理。

用于模拟 一开始业务数据量不大，只使用一台服务器。
随着时间的流逝，数据量增大了， 不断地增加分片服务器。
以及某些旧的服务器需要淘汰了，更换新的服务器的处理。

以及如果一个 分片服务器 Down 了， 如果通过语句查询出来。

以及 同时运行多个 mongos 进程的时候， 及 C# 客户端连接代码的处理。




系统环境

五台 CentOS 虚拟机， 用于担当 “片”  机器名称分别为
 MyCentOS_01    (192.168.253.209)
 MyCentOS_02    (192.168.253.210)  
 MyCentOS_03    (192.168.253.211)
 MyCentOS_04    (192.168.253.212)
 MyCentOS_05    (192.168.253.213)


一台 Windows 主机 （192.168.253.78）， 用于担当  “配置服务器”




步骤1.  启动配置服务器.

Windows 机器上，  下载  mongodb-win32-x86_64-2.4.6.zip
解压缩到 D: 盘
修改目录名为  mongodb

D: 盘下面， 创建一个 D:\data\db 目录
然后进入  D:\mongodb\bin 目录
运行
mongod.exe  --dbpath  D:\data\db 
启动配置服务器

 

步骤2. 启动 mongos 进程
Windows 机器上
进入 D:\mongodb\bin 目录
运行 
mongos  --port 30000  --configdb  192.168.253.78:27017
启动 mongos 进程

（
注意事项：  
1.运行 mongos , 必须要指定  --configdb 参数， 这个参数意思是 指定 配置服务器的地址 
2.  --configdb 参数, 后面需要写 具体的机器名称，或者 ip地址，不要使用 localhost
）



步骤3. 启动第一个片
在 MyCentOS_01  虚拟机上面, 运行
mkdir -p  /data/sdb
创建用于存储数据库文件的目录

运行
./mongod --dbpath  /data/sdb
启动 mongo 服务器端程序





步骤4. 添加第一个片
在 Windows 机器上
进入 D:\mongodb\bin 目录
运行 
mongo.exe  192.168.253.78:30000/admin
运行 mongo 客户端， 连接到 mongos

（
注意事项：
这里的端口， 是 mongos 的端口， 不要写成 配置服务器的端口
）



在 mongo 客户端中， 输入命令
db.runCommand({addshard : "192.168.253.209:27017",  "name" : "Basic Shard Server" })
新增一个片
系统返回：
{ "shardAdded" : "Basic Shard Server", "ok" : 1 }




步骤5. 数据库与表 的配置


运行
db.runCommand({"enableSharding" : "test"})
对数据库 test 启用 分片
系统返回：
{ "ok" : 1 }


运行
db.runCommand({"shardCollection" : "test.TestBasic",  "key" : {"_id" : 1}  })
对数据库  test  下面的  TestBasic  表， 启用分片
按照 _id  列进行分片
系统返回：
{ "collectionsharded" : "test.TestBasic", "ok" : 1 }




步骤6. 管理分片

在mongo 客户端中， 输入命令


mongos> use config
switched to db config


查询所有的 片
mongos> db.shards.find()
{ "_id" : "Basic Shard Server", "host" : "192.168.253.209:27017" }



步骤7. 插入测试数据


步骤8. 查看数据分布
mongos> use test
switched to db test


mongos> db.TestBasic.count()
50692

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Basic Shard Server      3
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Basic Shard Server Timestamp(1, 1)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Basic Shard Server Timestamp
(1, 3)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : { "$maxKey" : 1 } } on : Basic Shard Server Timestamp(1, 4)



通过上面的结果， 可以看出， 数据被分成了3个片。
但是由于 服务器只有1个， 因此， 3个片都存储在那个  “Basic Shard Server” 服务器上面。




步骤9. 启动第二个片
在  MyCentOS_02  虚拟机上面, 运行
mkdir -p  /data/sdb
创建用于存储数据库文件的目录

运行
./mongod --dbpath  /data/sdb
启动 mongo 服务器端程序




步骤10. 添加第二个片

mongos> use admin
switched to db admin

mongos> db.runCommand({addshard : "192.168.253.210:27017",  "name" : "Exp Shard Server 02" });
{ "shardAdded" : "Exp Shard Server 02", "ok" : 1 }



步骤11. 查询片的分布.

mongos>  use test
switched to db test

mongos> db.TestBasic.count()
100000

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 02",  "host" : "192.168.253.210:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 02     1
                                Basic Shard Server      2
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 02 Timestamp(2, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Basic Shard Server Timestamp
(2, 1)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : { "$maxKey" : 1 } } on : Basic Shard Server Timestamp(1, 4)



通过上面的结果， 可以看出， 数据被分成了3个片。
服务器有2个
其中1个片存储在那个  “Exp Shard Server 02” 服务器上面。
其中2个片存储在那个  “Basic Shard Server” 服务器上面。




步骤12. 启动第三个片
在  MyCentOS_03  虚拟机上面, 运行
mkdir -p  /data/sdb
创建用于存储数据库文件的目录

运行
./mongod --dbpath  /data/sdb
启动 mongo 服务器端程序




步骤13. 添加第三个片


mongos> use admin
switched to db admin

mongos> db.runCommand({addshard : "192.168.253.211:27017",  "name" : "Exp Shard Server 03" });
{ "shardAdded" : "Exp Shard Server 03", "ok" : 1 }





步骤14. 查询片的分布.

mongos>  use test
switched to db test

mongos> db.TestBasic.count()
100000

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 02",  "host" : "192.168.253.210:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 02     1
                                Exp Shard Server 03     1
                                Basic Shard Server      1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 02 Timestamp(2, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Exp Shard Server 03 Timestam
p(3, 0)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : { "$maxKey" : 1 } } on : Basic Shard Server Timestamp(3, 1)



通过上面的结果， 可以看出， 数据被分成了3个片。
服务器有3个
其中1个片存储在那个  “Exp Shard Server 02” 服务器上面。
其中1个片存储在那个  “Exp Shard Server 03” 服务器上面。
其中1个片存储在那个  “Basic Shard Server” 服务器上面。




步骤15.  继续插入测试数据



步骤16. 查询片的分布.

mongos> db.TestBasic.count()
239170

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 02",  "host" : "192.168.253.210:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 02     2
                                Exp Shard Server 03     1
                                Basic Shard Server      1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 02 Timestamp(2, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Exp Shard Server 03 Timestam
p(3, 0)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : ObjectId("525660b070da9a23008cc895") } on : Basic Shard Server Timestamp
(4, 1)
                        { "_id" : ObjectId("525660b070da9a23008cc895") } -->> {
"_id" : { "$maxKey" : 1 } } on : Exp Shard Server 02 Timestamp(4, 0)



通过上面的结果， 可以看出， 随着数据量的增加，数据被分成了4个片。
服务器有3个
其中2个片存储在那个  “Exp Shard Server 02” 服务器上面。
其中1个片存储在那个  “Exp Shard Server 03” 服务器上面。
其中1个片存储在那个  “Basic Shard Server” 服务器上面。





步骤17. 启动第四个片
在  MyCentOS_04  虚拟机上面, 运行
mkdir -p  /data/sdb
创建用于存储数据库文件的目录

运行
./mongod --dbpath  /data/sdb
启动 mongo 服务器端程序




步骤18. 添加第四个片


mongos> use admin
switched to db admin


mongos> db.runCommand({addshard : "192.168.253.212:27017",  "name" : "Exp Shard Server 04" });
{ "shardAdded" : "Exp Shard Server 04", "ok" : 1 }




步骤19. 查询片的分布.

mongos> use test
switched to db test

mongos> db.TestBasic.count()
300000

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 02",  "host" : "192.168.253.210:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
        {  "_id" : "Exp Shard Server 04",  "host" : "192.168.253.212:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 04     1
                                Exp Shard Server 03     1
                                Basic Shard Server      1
                                Exp Shard Server 02     1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 04 Timestamp(5, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Exp Shard Server 03 Timestam
p(3, 0)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : ObjectId("525660b070da9a23008cc895") } on : Basic Shard Server Timestamp
(4, 1)
                        { "_id" : ObjectId("525660b070da9a23008cc895") } -->> {
"_id" : { "$maxKey" : 1 } } on : Exp Shard Server 02 Timestamp(5, 1)




通过上面的结果， 可以看出， 随着数据量的增加，数据被分成了4个片。
服务器有4个
其中1个片存储在那个  “Exp Shard Server 04” 服务器上面。
其中1个片存储在那个  “Exp Shard Server 02” 服务器上面。
其中1个片存储在那个  “Exp Shard Server 03” 服务器上面。
其中1个片存储在那个  “Basic Shard Server” 服务器上面。






步骤20. 启动第五个片
在  MyCentOS_05  虚拟机上面, 运行
mkdir -p  /data/sdb
创建用于存储数据库文件的目录

运行
./mongod --dbpath  /data/sdb
启动 mongo 服务器端程序




步骤21.  移除 第二个片；  加入第五个片  ( 本操作模拟 新增一个服务器，更换掉旧有的服务器 )

mongos> use admin
switched to db admin

mongos> db.runCommand({removeShard : "Exp Shard Server 02" });
{
        "msg" : "draining started successfully",
        "state" : "started",
        "shard" : "Exp Shard Server 02",
        "ok" : 1
}

mongos> db.runCommand({addshard : "192.168.253.213:27017",  "name" : "Exp Shard Server 05" });
{ "shardAdded" : "Exp Shard Server 05", "ok" : 1 }


注意： 移除分片，是一个比较耗时的处理。
上面的返回结果中， state 是  started 
也就是 移除分片的处理开始了.
一段时间以后， 再次执行语句：

mongos> db.runCommand({removeShard : "Exp Shard Server 02" });
{
        "msg" : "removeshard completed successfully",
        "state" : "completed",
        "shard" : "Exp Shard Server 02",
        "ok" : 1
}

状态显示， 分片已经被移除了.



步骤22. 查询片的分布.


mongos> use test
switched to db test

mongos> db.TestBasic.count()
300000

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
        {  "_id" : "Exp Shard Server 04",  "host" : "192.168.253.212:27017" }
        {  "_id" : "Exp Shard Server 05",  "host" : "192.168.253.213:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 04     1
                                Exp Shard Server 03     1
                                Exp Shard Server 05     1
                                Basic Shard Server      1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 04 Timestamp(5, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Exp Shard Server 03 Timestam
p(3, 0)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : ObjectId("525660b070da9a23008cc895") } on : Exp Shard Server 05 Timestam
p(7, 0)
                        { "_id" : ObjectId("525660b070da9a23008cc895") } -->> {
"_id" : { "$maxKey" : 1 } } on : Basic Shard Server Timestamp(7, 1)



通过上面的结果， 可以看出，数据被分成了4个片。
服务器有4个
其中1个片存储在那个  “Exp Shard Server 04” 服务器上面。
其中1个片存储在那个  “Exp Shard Server 05” 服务器上面。
其中1个片存储在那个  “Exp Shard Server 03” 服务器上面。
其中1个片存储在那个  “Basic Shard Server” 服务器上面。

其中的  Exp Shard Server 02  已经被移除掉了， 因此在上面的列表中， 没有该片的信息。

通过与 步骤 19 的结果对比。

数据库可能是这样处理 移除与新增的处理的：

当移除 “Exp Shard Server 02”  的时候， 原本由 Exp Shard Server 02 存储的数据， 需要迁移到 “Basic Shard Server”  上面去。

当新增 “Exp Shard Server 05” 的时候，数据又从 “Basic Shard Server”  迁移一部分到  “Exp Shard Server 05”  上面去。






步骤23.  模拟某个分片发生故障


在  MyCentOS_03  虚拟机上面, 运行
shutdown -h now
关闭计算机



步骤24. 查询片的分布.

mongos> use test
switched to db test

mongos> db.TestBasic.count()
Thu Oct 10 17:06:24.159 count failed: { "code" : 15988, "ok" : 0, "errmsg" : "ex
ception: error querying server" } at src/mongo/shell/query.js:180


mongos> use config
switched to db config

mongos> db.mongos.find()
error: {
        "$err" : "socket exception [CONNECT_ERROR] for 192.168.253.211:27017",
        "code" : 11002,
        "shard" : "config"
}


mongos> db.shards.find()
error: {
        "$err" : "socket exception [CONNECT_ERROR] for 192.168.253.211:27017",
        "code" : 11002,
        "shard" : "config"
}




步骤25. 启动第三个片  （模拟某个分片发生故障后恢复）
在  MyCentOS_03  虚拟机上面
运行
./mongod --dbpath  /data/sdb
启动 mongo 服务器端程序




步骤26. 查询片的分布.

mongos> use test
switched to db test

mongos> db.TestBasic.count()
300000


mongos> use config
switched to db config

mongos> db.mongos.find()
{ "_id" : "EdwardPC:30000", "mongoVersion" : "2.4.6", "ping" : ISODate("2013-10-
10T09:16:20.179Z"), "up" : 7798, "waiting" : true }

mongos> db.shards.find()
{ "_id" : "Basic Shard Server", "host" : "192.168.253.209:27017" }
{ "_id" : "Exp Shard Server 03", "host" : "192.168.253.211:27017" }
{ "_id" : "Exp Shard Server 04", "host" : "192.168.253.212:27017" }
{ "_id" : "Exp Shard Server 05", "host" : "192.168.253.213:27017" }

mongos> db.databases.find();
{ "_id" : "admin", "partitioned" : false, "primary" : "config" }
{ "_id" : "test", "partitioned" : true, "primary" : "Basic Shard Server" }

mongos> db.collections.find();
{ "_id" : "test.TestBasic", "lastmod" : ISODate("1970-01-16T23:43:09.637Z"), "dr
opped" : false, "key" : { "_id" : 1 }, "unique" : false, "lastmodEpoch" : Object
Id("525655455b9ed4426aecea13") }

mongos> db.chunks.find();
{ "_id" : "test.TestBasic-_id_MinKey", "lastmod" : Timestamp(5, 0), "lastmodEpoc
h" : ObjectId("525655455b9ed4426aecea13"), "ns" : "test.TestBasic", "min" : { "_
id" : { "$minKey" : 1 } }, "max" : { "_id" : ObjectId("5256589670da9a26988abf39"
) }, "shard" : "Exp Shard Server 04" }
{ "_id" : "test.TestBasic-_id_ObjectId('5256589670da9a26988abf39')", "lastmod" :
Timestamp(3, 0), "lastmodEpoch" : ObjectId("525655455b9ed4426aecea13"), "ns" :
"test.TestBasic", "min" : { "_id" : ObjectId("5256589670da9a26988abf39") }, "max
" : { "_id" : ObjectId("525658c070da9a26988ade12") }, "shard" : "Exp Shard Serve
r 03" }
{ "_id" : "test.TestBasic-_id_ObjectId('525658c070da9a26988ade12')", "lastmod" :
Timestamp(7, 0), "lastmodEpoch" : ObjectId("525655455b9ed4426aecea13"), "ns" :
"test.TestBasic", "min" : { "_id" : ObjectId("525658c070da9a26988ade12") }, "max
" : { "_id" : ObjectId("525660b070da9a23008cc895") }, "shard" : "Exp Shard Serve
r 05" }
{ "_id" : "test.TestBasic-_id_ObjectId('525660b070da9a23008cc895')", "lastmod" :
Timestamp(7, 1), "lastmodEpoch" : ObjectId("525655455b9ed4426aecea13"), "ns" :
"test.TestBasic", "min" : { "_id" : ObjectId("525660b070da9a23008cc895") }, "max
" : { "_id" : { "$maxKey" : 1 } }, "shard" : "Basic Shard Server" }




步骤27.  启动第二个 mongos 进程  （用于避免第一个 mongos 进程 Down 掉 ）
Windows 机器上
进入 D:\mongodb\bin 目录
运行 
mongos  --port 30001  --configdb  192.168.253.78:27017
启动 mongos 进程



步骤28.  C# 客户端代码


            // 下面这种情况, 是用于多个 mongos 进程的情况.
            MongoClientSettings setting = new MongoClientSettings();
            setting.ConnectionMode = ConnectionMode.ShardRouter;

            setting.Servers = new List <MongoServerAddress>() {
                new MongoServerAddress ("192.168.253.78", 30000),
                new MongoServerAddress ("192.168.253.78", 30001) };

            MongoClient client = new MongoClient(setting);


运行并插入数据。
核对数据量


步骤29.  停掉第一个 mongos 进程

在步骤2 的 “mongos” 窗口上， 按 Ctrl+C 停止该进程。



步骤30. 再次运行 C# 客户端代码

运行并插入数据。
核对数据量




步骤31.  备份的处理


D:\mongodb\bin>mongodump.exe -h 192.168.253.78:30001 -d test -o d:\test
connected to: 192.168.253.78:30001
Thu Oct 10 18:42:21.424 DATABASE: test   to     d:\test\test
Thu Oct 10 18:42:21.446         test.system.indexes to d:\test\test\system.index
es.bson
Thu Oct 10 18:42:21.451                  1 objects
Thu Oct 10 18:42:21.453         test.TestBasic to d:\test\test\TestBasic.bson
Thu Oct 10 18:42:24.193                 Collection File Writing Progress: 109900
/500000 21%     (objects)
Thu Oct 10 18:42:27.515                 Collection File Writing Progress: 403900
/500000 80%     (objects)
Thu Oct 10 18:42:27.658                  500000 objects
Thu Oct 10 18:42:27.659         Metadata for test.TestBasic to d:\test\test\Test
Basic.metadata.json


上面的操作, 是 通过 连接  mongos,   一次性备份全部分片的数据.




步骤32.  模拟  分片正常  配置服务器物理损坏.

把前面 步骤1 的  mongod.exe  停掉 
步骤2 与 步骤 27 的 mongos 全部停掉

D: 盘下面， 创建一个 D:\data\db2 目录
然后进入  D:\mongodb\bin 目录
运行
mongod.exe  --dbpath  D:\data\db2 
启动配置服务器

 

步骤33. 启动 mongos 进程
Windows 机器上
进入 D:\mongodb\bin 目录
运行 
mongos  --port 30000  --configdb  192.168.253.78:27017
启动 mongos 进程


步骤34. 重新加入分片

D:\mongodb\bin>mongo.exe  192.168.253.78:30000/admin
MongoDB shell version: 2.4.6
connecting to: 192.168.253.78:30000/admin
mongos> db.runCommand({addshard : "192.168.253.209:27017",  "name" : "Basic Shard Server" })
{ "shardAdded" : "Basic Shard Server", "ok" : 1 }

mongos> db.runCommand({addshard : "192.168.253.210:27017",  "name" : "Exp Shard Server 02" });
{
        "ok" : 0,
        "errmsg" : "can't add shard 192.168.253.210:27017 because a local databa
se 'test' exists in another Basic Shard Server:192.168.253.209:27017"
}

mongos> db.runCommand({addshard : "192.168.253.211:27017",  "name" : "Exp Shard Server 03" });
{
        "ok" : 0,
        "errmsg" : "can't add shard 192.168.253.211:27017 because a local databa
se 'test' exists in another Basic Shard Server:192.168.253.209:27017"
}


上面的执行结果显示，  如果 配置服务器 物理损坏了， 重新搭建一个新的 配置服务器， 没法简单的加入已有的 分片服务器了。


终止上面的 步骤23 的 配置服务器 与 步骤24 的 mongos 进程.



重新启动 步骤1的 配置服务器 与 步骤2的  mongos 进程.


D:\mongodb\bin>mongo.exe  192.168.253.78:30000/admin
MongoDB shell version: 2.4.6
connecting to: 192.168.253.78:30000/admin

mongos> use test
switched to db test

mongos>  db.TestBasic.count()
500000

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
        {  "_id" : "Exp Shard Server 04",  "host" : "192.168.253.212:27017" }
        {  "_id" : "Exp Shard Server 05",  "host" : "192.168.253.213:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 04     1
                                Exp Shard Server 03     2
                                Exp Shard Server 05     1
                                Basic Shard Server      1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 04 Timestamp(5, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Exp Shard Server 03 Timestam
p(3, 0)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : ObjectId("525660b070da9a23008cc895") } on : Exp Shard Server 05 Timestam
p(7, 0)
                        { "_id" : ObjectId("525660b070da9a23008cc895") } -->> {
"_id" : ObjectId("52567a9e70da9a2bbc76c2a9") } on : Basic Shard Server Timestamp
(8, 1)
                        { "_id" : ObjectId("52567a9e70da9a2bbc76c2a9") } -->> {
"_id" : { "$maxKey" : 1 } } on : Exp Shard Server 03 Timestamp(8, 0)


显示各分片数据都正常。



再把 前面移除掉的  第2个片， 加进来

mongos> use admin
switched to db admin

mongos>  db.runCommand({addshard : "192.168.253.210:27017",  "name" : "Exp Shard Server 02" });
{
        "ok" : 0,
        "errmsg" : "can't add shard 192.168.253.210:27017 because a local database 'test' exists in another Basic Shard Server:192.168.253.209:27017"
}



结果还是报错。
命令行 单独连接到这个 服务器上面去， 删除 分片2上面的 test 数据库。


D:\mongodb\bin>mongo 192.168.253.210:27017

> use test
switched to db test

> show dbs
local   0.03125GB
test    0.0625GB

> db.dropDatabase()
{ "dropped" : "test", "ok" : 1 }

> show dbs
local   0.03125GB
>



回到 mongos 客户端

mongos> db.runCommand({addshard : "192.168.253.210:27017",  "name" : "Exp Shard Server 02" });
{ "shardAdded" : "Exp Shard Server 02", "ok" : 1 }
mongos>

mongos> use test
switched to db test

mongos> db.TestBasic.count()
500000

mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 02",  "host" : "192.168.253.210:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
        {  "_id" : "Exp Shard Server 04",  "host" : "192.168.253.212:27017" }
        {  "_id" : "Exp Shard Server 05",  "host" : "192.168.253.213:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 04     1
                                Exp Shard Server 02     1
                                Exp Shard Server 05     1
                                Basic Shard Server      1
                                Exp Shard Server 03     1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 04 Timestamp(5, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Exp Shard Server 02 Timestam
p(9, 0)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : ObjectId("525660b070da9a23008cc895") } on : Exp Shard Server 05 Timestam
p(7, 0)
                        { "_id" : ObjectId("525660b070da9a23008cc895") } -->> {
"_id" : ObjectId("52567a9e70da9a2bbc76c2a9") } on : Basic Shard Server Timestamp
(8, 1)
                        { "_id" : ObjectId("52567a9e70da9a2bbc76c2a9") } -->> {
"_id" : { "$maxKey" : 1 } } on : Exp Shard Server 03 Timestamp(9, 1)




步骤35.   独立备份每一个分片的处理


mongodump.exe -h 192.168.253.209 -d test -o   d:\test\01
mongodump.exe -h 192.168.253.210 -d test -o   d:\test\02
mongodump.exe -h 192.168.253.211 -d test -o   d:\test\03
mongodump.exe -h 192.168.253.212 -d test -o   d:\test\04
mongodump.exe -h 192.168.253.213 -d test -o   d:\test\05

运行结果：
D:\mongodb\bin>mongodump.exe -h 192.168.253.209 -d test -o   d:\test\01
connected to: 192.168.253.209
Fri Oct 11 11:19:54.350 DATABASE: test   to     d:\test\01\test
Fri Oct 11 11:19:54.356         test.system.indexes to d:\test\01\test\system.in
dexes.bson
Fri Oct 11 11:19:54.361                  1 objects
Fri Oct 11 11:19:54.361         test.TestBasic to d:\test\01\test\TestBasic.bson

Fri Oct 11 11:19:56.530                  207418 objects
Fri Oct 11 11:19:56.532         Metadata for test.TestBasic to d:\test\01\test\T
estBasic.metadata.json

D:\mongodb\bin>mongodump.exe -h 192.168.253.210 -d test -o   d:\test\02
connected to: 192.168.253.210
Fri Oct 11 11:19:56.676 DATABASE: test   to     d:\test\02\test
Fri Oct 11 11:19:56.680         test.system.indexes to d:\test\02\test\system.in
dexes.bson
Fri Oct 11 11:19:56.683                  1 objects
Fri Oct 11 11:19:56.684         test.TestBasic to d:\test\02\test\TestBasic.bson

Fri Oct 11 11:19:56.727                  7897 objects
Fri Oct 11 11:19:56.728         Metadata for test.TestBasic to d:\test\02\test\T
estBasic.metadata.json

D:\mongodb\bin>mongodump.exe -h 192.168.253.211 -d test -o   d:\test\03
connected to: 192.168.253.211
Fri Oct 11 11:19:56.866 DATABASE: test   to     d:\test\03\test
Fri Oct 11 11:19:56.869         test.system.indexes to d:\test\03\test\system.in
dexes.bson
Fri Oct 11 11:19:56.874                  1 objects
Fri Oct 11 11:19:56.875         test.TestBasic to d:\test\03\test\TestBasic.bson

Fri Oct 11 11:19:57.651                  73824 objects
Fri Oct 11 11:19:57.652         Metadata for test.TestBasic to d:\test\03\test\T
estBasic.metadata.json

D:\mongodb\bin>mongodump.exe -h 192.168.253.212 -d test -o   d:\test\04
connected to: 192.168.253.212
Fri Oct 11 11:19:57.799 DATABASE: test   to     d:\test\04\test
Fri Oct 11 11:19:57.804         test.system.indexes to d:\test\04\test\system.in
dexes.bson
Fri Oct 11 11:19:57.808                  1 objects
Fri Oct 11 11:19:57.809         test.TestBasic to d:\test\04\test\TestBasic.bson

Fri Oct 11 11:19:57.813                  0 objects
Fri Oct 11 11:19:57.814         Metadata for test.TestBasic to d:\test\04\test\T
estBasic.metadata.json

D:\mongodb\bin>mongodump.exe -h 192.168.253.213 -d test -o   d:\test\05
connected to: 192.168.253.213
Fri Oct 11 11:19:57.952 DATABASE: test   to     d:\test\05\test
Fri Oct 11 11:19:57.957         test.system.indexes to d:\test\05\test\system.in
dexes.bson
Fri Oct 11 11:19:57.960                  1 objects
Fri Oct 11 11:19:57.961         test.TestBasic to d:\test\05\test\TestBasic.bson

Fri Oct 11 11:20:00.067                 Collection File Writing Progress: 172700
/210861 81%     (objects)
Fri Oct 11 11:20:00.079                  210861 objects
Fri Oct 11 11:20:00.080         Metadata for test.TestBasic to d:\test\05\test\T
estBasic.metadata.json



上面的 备份结果显示， 虽然分了5 个区， 但是每个区的数据分布， 是不均匀的。





<hr/>

本文档为在  一个包含 5个分片的 mongoDB  服务器上。
自定义 文档的 分片规则的例子。
例子 是一个订单的文档。
分片按照  （ 订单日期，  顾客代码） 进行分片的处理

插入测试数据后。
不指定条件的情况下， 将启用全表扫描.
指定 订单日期条件 与 顾客代码条件 将 启用索引.
仅仅指定 订单日期条件 将 启用索引.
仅仅指定 顾客代码条件 将 启用全表扫描.

分片的情况下，如果某个分片故障了。
如果查询语句，需要访问故障分片，那么执行将报错。
如果查询语句，不访问故障分片，那么执行将正常返回。




系统环境



mongos> use config
switched to db config

mongos>  db.shards.find()
{ "_id" : "Basic Shard Server", "host" : "192.168.253.209:27017" }
{ "_id" : "Exp Shard Server 03", "host" : "192.168.253.211:27017" }
{ "_id" : "Exp Shard Server 04", "host" : "192.168.253.212:27017" }
{ "_id" : "Exp Shard Server 05", "host" : "192.168.253.213:27017" }
{ "_id" : "Exp Shard Server 02", "host" : "192.168.253.210:27017" }

mongos> db.databases.find();
{ "_id" : "admin", "partitioned" : false, "primary" : "config" }
{ "_id" : "test", "partitioned" : true, "primary" : "Basic Shard Server" }




mongos> use test
switched to db test

mongos> db.stats();
{
        "raw" : {
                "192.168.253.209:27017" : {
                        "db" : "test",
                        "collections" : 3,
                        "objects" : 207422,
                        "avgObjSize" : 95.99899721341035,
                        "dataSize" : 19912304,
                        "storageSize" : 58449920,
                        "numExtents" : 11,
                        "indexes" : 1,
                        "indexSize" : 6753376,
                        "fileSize" : 251658240,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.210:27017" : {
                        "db" : "test",
                        "collections" : 3,
                        "objects" : 7901,
                        "avgObjSize" : 71.98683710922668,
                        "dataSize" : 568768,
                        "storageSize" : 708608,
                        "numExtents" : 6,
                        "indexes" : 1,
                        "indexSize" : 269808,
                        "fileSize" : 50331648,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.211:27017" : {
                        "db" : "test",
                        "collections" : 3,
                        "objects" : 73828,
                        "avgObjSize" : 95.99718264073252,
                        "dataSize" : 7087280,
                        "storageSize" : 11194368,
                        "numExtents" : 8,
                        "indexes" : 1,
                        "indexSize" : 2411920,
                        "fileSize" : 50331648,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.212:27017" : {
                        "db" : "test",
                        "collections" : 3,
                        "objects" : 4,
                        "avgObjSize" : 44,
                        "dataSize" : 176,
                        "storageSize" : 20480,
                        "numExtents" : 3,
                        "indexes" : 1,
                        "indexSize" : 8176,
                        "fileSize" : 50331648,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.213:27017" : {
                        "db" : "test",
                        "collections" : 3,
                        "objects" : 210865,
                        "avgObjSize" : 80.96349797263652,
                        "dataSize" : 17072368,
                        "storageSize" : 22519808,
                        "numExtents" : 9,
                        "indexes" : 1,
                        "indexSize" : 9443280,
                        "fileSize" : 117440512,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                }
        },
        "objects" : 500020,
        "avgObjSize" : 88.29466221351146,
        "dataSize" : 44640896,
        "storageSize" : 92893184,
        "numExtents" : 37,
        "indexes" : 5,
        "indexSize" : 18886560,
        "fileSize" : 520093696,
        "ok" : 1
}


mongos> db.printShardingStatus()
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 02",  "host" : "192.168.253.210:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
        {  "_id" : "Exp Shard Server 04",  "host" : "192.168.253.212:27017" }
        {  "_id" : "Exp Shard Server 05",  "host" : "192.168.253.213:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic
                        shard key: { "_id" : 1 }
                        chunks:
                                Exp Shard Server 04     1
                                Exp Shard Server 02     1
                                Exp Shard Server 05     1
                                Basic Shard Server      1
                                Exp Shard Server 03     1
                        { "_id" : { "$minKey" : 1 } } -->> { "_id" : ObjectId("5
256589670da9a26988abf39") } on : Exp Shard Server 04 Timestamp(5, 0)
                        { "_id" : ObjectId("5256589670da9a26988abf39") } -->> {
"_id" : ObjectId("525658c070da9a26988ade12") } on : Exp Shard Server 02 Timestam
p(9, 0)
                        { "_id" : ObjectId("525658c070da9a26988ade12") } -->> {
"_id" : ObjectId("525660b070da9a23008cc895") } on : Exp Shard Server 05 Timestam
p(7, 0)
                        { "_id" : ObjectId("525660b070da9a23008cc895") } -->> {
"_id" : ObjectId("52567a9e70da9a2bbc76c2a9") } on : Basic Shard Server Timestamp
(8, 1)
                        { "_id" : ObjectId("52567a9e70da9a2bbc76c2a9") } -->> {
"_id" : { "$maxKey" : 1 } } on : Exp Shard Server 03 Timestamp(9, 1)





测试数据基本结构 （在另外一台测试计算机上的输出）

> db.TestGoods.find();
{ "_id" : ObjectId("52577b9370da9a1708ce5345"), "GoodsCode" : "A001", "GoodsName" : "苹果", "GoodsPrice" : 20 }
{ "_id" : ObjectId("52577b9370da9a1708ce5346"), "GoodsCode" : "A002", "GoodsName" : "梨子", "GoodsPrice" : 10 }
{ "_id" : ObjectId("52577b9370da9a1708ce5347"), "GoodsCode" : "A003", "GoodsName" : "桔子", "GoodsPrice" : 5 }
{ "_id" : ObjectId("52577b9370da9a1708ce5348"), "GoodsCode" : "A004", "GoodsName" : "葡萄", "GoodsPrice" : 15 }
{ "_id" : ObjectId("52577b9370da9a1708ce5349"), "GoodsCode" : "A005", "GoodsName" : "芒果", "GoodsPrice" : 25 }



> db.TestOrder.find().limit(1);
{ "_id" : ObjectId("52577b9370da9a1708ce534a"),
  "CustomerCode" : "C_00000",
  "CustomerName" : "张0",
  "OrderDate" : ISODate("2013-10-10T16:00:00Z"),
  "OrderDetail" : [   
     {       "_id" : ObjectId("52577b9370da9a1708ce5345"),   "GoodsCode" : "A001",   "GoodsName" : "苹果",   "GoodsPrice" : 20,      "GoodsCount" : 23 },
     {       "_id" : ObjectId("52577b9370da9a1708ce5346"),   "GoodsCode" : "A002",   "GoodsName" : "梨子",   "GoodsPrice" : 10,      "GoodsCount" : 33 },   
     {       "_id" : ObjectId("52577b9370da9a1708ce5347"),   "GoodsCode" : "A003",   "GoodsName" : "桔子",   "GoodsPrice" : 5,       "GoodsCount" : 25 },   
     {       "_id" : ObjectId("52577b9370da9a1708ce5348"),   "GoodsCode" : "A004",   "GoodsName" : "葡萄",   "GoodsPrice" : 15,      "GoodsCount" : 73 },   
     {       "_id" : ObjectId("52577b9370da9a1708ce5349"),   "GoodsCode" : "A005",   "GoodsName" : "芒果",   "GoodsPrice" : 25,      "GoodsCount" : 29 }
     ]
}





步骤1.   配置分片的设置

mongos> use admin
switched to db admin

test 数据库已经 启用分片了， 这里就不需要再执行  db.runCommand({"enableSharding" : "test"})

mongos> db.runCommand({"shardCollection" : "test.TestOrder",  "key" : {"OrderDate" : 1,  "CustomerCode" : 1}  });
{ "collectionsharded" : "test.TestOrder", "ok" : 1 }


这里是  按照 订单表的   ( 订单日期,  顾客代码 )  进行分片处理.



步骤2.  批量插入数据.


步骤3. 查询分片分布情况

mongos> use test
switched to db test

mongos> db.TestOrder.count();
500000

mongos> db.printShardingStatus();
--- Sharding Status ---
  sharding version: {
        "_id" : 1,
        "version" : 3,
        "minCompatibleVersion" : 3,
        "currentVersion" : 4,
        "clusterId" : ObjectId("525651ee5b9ed4426aece981")
}
  shards:
        {  "_id" : "Basic Shard Server",  "host" : "192.168.253.209:27017" }
        {  "_id" : "Exp Shard Server 02",  "host" : "192.168.253.210:27017" }
        {  "_id" : "Exp Shard Server 03",  "host" : "192.168.253.211:27017" }
        {  "_id" : "Exp Shard Server 04",  "host" : "192.168.253.212:27017" }
        {  "_id" : "Exp Shard Server 05",  "host" : "192.168.253.213:27017" }
  databases:
        {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
        {  "_id" : "test",  "partitioned" : true,  "primary" : "Basic Shard Serv
er" }
                test.TestBasic  （因为主要观察的目标是TestOrder，因此这里删除部分信息，下同）
                test.TestOrder
                        shard key: { "OrderDate" : 1, "CustomerCode" : 1 }
                        chunks:
                                Exp Shard Server 03     3
                                Basic Shard Server      2
                                Exp Shard Server 02     2
                                Exp Shard Server 04     2
                                Exp Shard Server 05     2
                        { "OrderDate" : { "$minKey" : 1 }, "CustomerCode" : { "$
minKey" : 1 } } -->> { "OrderDate" : ISODate("2013-10-10T16:00:00Z"), "CustomerC
ode" : "C00003" } on : Exp Shard Server 03 Timestamp(3, 0)
                        { "OrderDate" : ISODate("2013-10-10T16:00:00Z"), "Custom
erCode" : "C00003" } -->> { "OrderDate" : ISODate("2014-03-10T16:00:00Z"), "Cust
omerCode" : "C00003" } on : Basic Shard Server Timestamp(5, 8)
                        { "OrderDate" : ISODate("2014-03-10T16:00:00Z"), "Custom
erCode" : "C00003" } -->> { "OrderDate" : ISODate("2014-08-19T16:00:00Z"), "Cust
omerCode" : "C00007" } on : Basic Shard Server Timestamp(5, 9)
                        { "OrderDate" : ISODate("2014-08-19T16:00:00Z"), "Custom
erCode" : "C00007" } -->> { "OrderDate" : ISODate("2015-04-25T16:00:00Z"), "Cust
omerCode" : "C00006" } on : Exp Shard Server 02 Timestamp(6, 0)
                        { "OrderDate" : ISODate("2015-04-25T16:00:00Z"), "Custom
erCode" : "C00006" } -->> { "OrderDate" : ISODate("2015-09-25T16:00:00Z"), "Cust
omerCode" : "C00006" } on : Exp Shard Server 04 Timestamp(6, 1)
                        { "OrderDate" : ISODate("2015-09-25T16:00:00Z"), "Custom
erCode" : "C00006" } -->> { "OrderDate" : ISODate("2016-03-21T16:00:00Z"), "Cust
omerCode" : "C00007" } on : Exp Shard Server 04 Timestamp(5, 7)
                        { "OrderDate" : ISODate("2016-03-21T16:00:00Z"), "Custom
erCode" : "C00007" } -->> { "OrderDate" : ISODate("2016-08-18T16:00:00Z"), "Cust
omerCode" : "C00007" } on : Exp Shard Server 03 Timestamp(7, 2)
                        { "OrderDate" : ISODate("2016-08-18T16:00:00Z"), "Custom
erCode" : "C00007" } -->> { "OrderDate" : ISODate("2017-04-08T16:00:00Z"), "Cust
omerCode" : "C00007" } on : Exp Shard Server 03 Timestamp(7, 3)
                        { "OrderDate" : ISODate("2017-04-08T16:00:00Z"), "Custom
erCode" : "C00007" } -->> { "OrderDate" : ISODate("2018-02-21T16:00:00Z"), "Cust
omerCode" : "C00007" } on : Exp Shard Server 05 Timestamp(7, 1)
                        { "OrderDate" : ISODate("2018-02-21T16:00:00Z"), "Custom
erCode" : "C00007" } -->> { "OrderDate" : ISODate("2020-10-07T16:00:00Z"), "Cust
omerCode" : "C00007" } on : Exp Shard Server 05 Timestamp(5, 11)
                        { "OrderDate" : ISODate("2020-10-07T16:00:00Z"), "Custom
erCode" : "C00007" } -->> { "OrderDate" : { "$maxKey" : 1 }, "CustomerCode" : {
"$maxKey" : 1 } } on : Exp Shard Server 02 Timestamp(5, 1)


上面的结果显示：50万数据， 被分割为 11个片
由于 只有5个服务器。
因此
有 4个服务器， 每个服务器要存储2个片。  
有1个服务器上面，要存储3个片。



mongos> db.TestOrder.getIndexes();
[
        {
                "v" : 1,
                "key" : {
                        "_id" : 1
                },
                "ns" : "test.TestOrder",
                "name" : "_id_"
        },
        {
                "v" : 1,
                "key" : {
                        "OrderDate" : 1,
                        "CustomerCode" : 1
                },
                "ns" : "test.TestOrder",
                "name" : "OrderDate_1_CustomerCode_1"
        }
]

上面结果显示， TestOrder 表上面有 2个索引， 
其中一个是系统的 _id， 
另外一个是 分片产生的索引。









步骤4. 查询计划的分析


4.1. 查询全部.
mongos> db.TestOrder.find().explain();
{
        "clusteredType" : "ParallelSort",
        "shards" : {
                "192.168.253.209:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 94788,
                                "nscannedObjects" : 94788,
                                "nscanned" : 94788,
                                "nscannedObjectsAllPlans" : 94788,
                                "nscannedAllPlans" : 94788,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 713,
                                "indexBounds" : {

                                },
                                "server" : "mongodb01:27017"
                        }
                ],
                "192.168.253.210:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 74776,
                                "nscannedObjects" : 74776,
                                "nscanned" : 74776,
                                "nscannedObjectsAllPlans" : 74776,
                                "nscannedAllPlans" : 74776,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 391,
                                "indexBounds" : {

                                },
                                "server" : "mongodb02:27017"
                        }
                ],
                "192.168.253.211:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 97955,
                                "nscannedObjects" : 97955,
                                "nscanned" : 97955,
                                "nscannedObjectsAllPlans" : 97955,
                                "nscannedAllPlans" : 97955,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 580,
                                "indexBounds" : {

                                },
                                "server" : "mongodb03:27017"
                        }
                ],
                "192.168.253.212:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 99172,
                                "nscannedObjects" : 99172,
                                "nscanned" : 99172,
                                "nscannedObjectsAllPlans" : 99172,
                                "nscannedAllPlans" : 99172,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 653,
                                "indexBounds" : {

                                },
                                "server" : "mongodb04:27017"
                        }
                ],
                "192.168.253.213:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 133309,
                                "nscannedObjects" : 133309,
                                "nscanned" : 133309,
                                "nscannedObjectsAllPlans" : 133309,
                                "nscannedAllPlans" : 133309,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 821,
                                "indexBounds" : {

                                },
                                "server" : "mongodb05:27017"
                        }
                ]
        },
        "cursor" : "BasicCursor",
        "n" : 500000,
        "nChunkSkips" : 0,
        "nYields" : 0,
        "nscanned" : 500000,
        "nscannedAllPlans" : 500000,
        "nscannedObjects" : 500000,
        "nscannedObjectsAllPlans" : 500000,
        "millisShardTotal" : 3158,
        "millisShardAvg" : 631,
        "numQueries" : 5,
        "numShards" : 5,
        "millis" : 825
}


从结果观察到，  查询全部， 意味着 每一个片， 都要访问到。
因此， 查询计划中显示， 需要访问 5 个片

"cursor" : "BasicCursor"  意味着 没有使用索引， 是属于 “全表扫描” 的处理机制。
"n" : 500000  表示返回的文档数量。
"numShards" : 5  表示查询将查询5个片


4.2. 查询 2013年11月1日  C00004 的信息.


mongos> db.TestOrder.find( { "OrderDate" : ISODate("2013-11-01T16:00:00Z"), "CustomerCode" : "C00004"  } ).explain();
{
        "clusteredType" : "ParallelSort",
        "shards" : {
                "192.168.253.209:27017" : [
                        {
                                "cursor" : "BtreeCursor OrderDate_1_CustomerCode_1",
                                "isMultiKey" : false,
                                "n" : 69,
                                "nscannedObjects" : 69,
                                "nscanned" : 69,
                                "nscannedObjectsAllPlans" : 69,
                                "nscannedAllPlans" : 69,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 0,
                                "indexBounds" : {
                                        "OrderDate" : [
                                                [
                                                        ISODate("2013-11-01T16:00:00Z"),
                                                        ISODate("2013-11-01T16:00:00Z")
                                                ]
                                        ],
                                        "CustomerCode" : [
                                                [
                                                        "C00004",
                                                        "C00004"
                                                ]
                                        ]
                                },
                                "server" : "mongodb01:27017"
                        }
                ]
        },
        "cursor" : "BtreeCursor OrderDate_1_CustomerCode_1",
        "n" : 69,
        "nChunkSkips" : 0,
        "nYields" : 0,
        "nscanned" : 69,
        "nscannedAllPlans" : 69,
        "nscannedObjects" : 69,
        "nscannedObjectsAllPlans" : 69,
        "millisShardTotal" : 0,
        "millisShardAvg" : 0,
        "numQueries" : 1,
        "numShards" : 1,
        "indexBounds" : {
                "OrderDate" : [
                        [
                                ISODate("2013-11-01T16:00:00Z"),
                                ISODate("2013-11-01T16:00:00Z")
                        ]
                ],
                "CustomerCode" : [
                        [
                                "C00004",
                                "C00004"
                        ]
                ]
        },
        "millis" : 3
}


从结果观察到，  查询 2013年11月1日 C00004 的数据
由于 分片是 按照 日期 + 顾客代码 进行分片的
通过查询条件， 可以明确的指定， 数据位于哪一个分片。
因此， 查询计划中显示， 仅仅需要访问  "192.168.253.209:27017"  这个分片

"cursor" : "BtreeCursor OrderDate_1_CustomerCode_1"  意味着本查询将使用一个索引。
"n" : 69 表示返回的文档数量。
"numShards" : 1  表示查询将查询1个片


4.3. 查询 2013年11月1日的信息.

mongos> db.TestOrder.find( { "OrderDate" : ISODate("2013-11-01T16:00:00Z") } ).explain();
{
        "clusteredType" : "ParallelSort",
        "shards" : {
                "192.168.253.209:27017" : [
                        {
                                "cursor" : "BtreeCursor OrderDate_1_CustomerCode_1",
                                "isMultiKey" : false,
                                "n" : 302,
                                "nscannedObjects" : 302,
                                "nscanned" : 302,
                                "nscannedObjectsAllPlans" : 302,
                                "nscannedAllPlans" : 302,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 3,
                                "indexBounds" : {
                                        "OrderDate" : [
                                                [
                                                        ISODate("2013-11-01T16:00:00Z"),
                                                        ISODate("2013-11-01T16:00:00Z")
                                                ]
                                        ],
                                        "CustomerCode" : [
                                                [
                                                        {
                                                                "$minElement" :1
                                                        },
                                                        {
                                                                "$maxElement" :1
                                                        }
                                                ]
                                        ]
                                },
                                "server" : "mongodb01:27017"
                        }
                ]
        },
        "cursor" : "BtreeCursor OrderDate_1_CustomerCode_1",
        "n" : 302,
        "nChunkSkips" : 0,
        "nYields" : 0,
        "nscanned" : 302,
        "nscannedAllPlans" : 302,
        "nscannedObjects" : 302,
        "nscannedObjectsAllPlans" : 302,
        "millisShardTotal" : 3,
        "millisShardAvg" : 3,
        "numQueries" : 1,
        "numShards" : 1,
        "indexBounds" : {
                "OrderDate" : [
                        [
                                ISODate("2013-11-01T16:00:00Z"),
                                ISODate("2013-11-01T16:00:00Z")
                        ]
                ],
                "CustomerCode" : [
                        [
                                {
                                        "$minElement" : 1
                                },
                                {
                                        "$maxElement" : 1
                                }
                        ]
                ]
        },
        "millis" : 6
}
mongos>


从结果观察到，  查询 2013年11月1日 的数据
由于 分片是 按照 日期 + 顾客代码 进行分片的
通过查询条件， 可以明确的指定， 数据位于哪一个分片。
因此， 查询计划中显示， 仅仅需要访问  "192.168.253.209:27017"  这个分片



4.4. 查询 C00003 的信息.

mongos> db.TestOrder.find( { "CustomerCode" : "C00003"  } ).explain();
{
        "clusteredType" : "ParallelSort",
        "shards" : {
                "192.168.253.209:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 28888,
                                "nscannedObjects" : 94788,
                                "nscanned" : 94788,
                                "nscannedObjectsAllPlans" : 94788,
                                "nscannedAllPlans" : 94788,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 368,
                                "indexBounds" : {

                                },
                                "server" : "mongodb01:27017"
                        }
                ],
                "192.168.253.210:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 22700,
                                "nscannedObjects" : 74776,
                                "nscanned" : 74776,
                                "nscannedObjectsAllPlans" : 74776,
                                "nscannedAllPlans" : 74776,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 285,
                                "indexBounds" : {

                                },
                                "server" : "mongodb02:27017"
                        }
                ],
                "192.168.253.211:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 18291,
                                "nscannedObjects" : 97955,
                                "nscanned" : 97955,
                                "nscannedObjectsAllPlans" : 97955,
                                "nscannedAllPlans" : 97955,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 172,
                                "indexBounds" : {

                                },
                                "server" : "mongodb03:27017"
                        }
                ],
                "192.168.253.212:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 30121,
                                "nscannedObjects" : 99172,
                                "nscanned" : 99172,
                                "nscannedObjectsAllPlans" : 99172,
                                "nscannedAllPlans" : 99172,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 392,
                                "indexBounds" : {

                                },
                                "server" : "mongodb04:27017"
                        }
                ],
                "192.168.253.213:27017" : [
                        {
                                "cursor" : "BasicCursor",
                                "isMultiKey" : false,
                                "n" : 0,
                                "nscannedObjects" : 133309,
                                "nscanned" : 133309,
                                "nscannedObjectsAllPlans" : 133309,
                                "nscannedAllPlans" : 133309,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 297,
                                "indexBounds" : {

                                },
                                "server" : "mongodb05:27017"
                        }
                ]
        },
        "cursor" : "BasicCursor",
        "n" : 100000,
        "nChunkSkips" : 0,
        "nYields" : 0,
        "nscanned" : 500000,
        "nscannedAllPlans" : 500000,
        "nscannedObjects" : 500000,
        "nscannedObjectsAllPlans" : 500000,
        "millisShardTotal" : 1514,
        "millisShardAvg" : 302,
        "numQueries" : 5,
        "numShards" : 5,
        "millis" : 419
}


可以观察到， 与关系型数据库的分区表的机制很相像。
分片是 按照 日期 + 顾客代码 进行分片的
内部的组织机制， 是先按照日期分， 然后再同一个日期里面， 再对顾客代码分。
如果仅仅 指定一个   顾客代码的 条件。
将无法使用索引， 因此查询将 访问 全部的分片， 并全表扫描进行处理。


4.5.  查询 2014年全年  C00004 的信息.

mongos> db.TestOrder.find( { "OrderDate" : { "$gte" : ISODate("2014-01-01T16:00:00Z") ,  "$lt" : ISODate("2015-01-01T16:00:00Z") }, "CustomerCode" : "C00004"  }).explain();
{
        "clusteredType" : "ParallelSort",
        "shards" : {
                "192.168.253.209:27017" : [
                        {
                                "cursor" : "BtreeCursor OrderDate_1_CustomerCode_1",
                                "isMultiKey" : false,
                                "n" : 15939,
                                "nscannedObjects" : 15939,
                                "nscanned" : 16399,
                                "nscannedObjectsAllPlans" : 16042,
                                "nscannedAllPlans" : 16502,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 147,
                                "indexBounds" : {
                                        "OrderDate" : [
                                                [
                                                        ISODate("2014-01-01T16:00:00Z"),
                                                        ISODate("2015-01-01T16:00:00Z")
                                                ]
                                        ],
                                        "CustomerCode" : [
                                                [
                                                        "C00004",
                                                        "C00004"
                                                ]
                                        ]
                                },
                                "server" : "mongodb01:27017"
                        }
                ],
                "192.168.253.210:27017" : [
                        {
                                "cursor" : "BtreeCursor OrderDate_1_CustomerCode_1",
                                "isMultiKey" : false,
                                "n" : 9246,
                                "nscannedObjects" : 9246,
                                "nscanned" : 9514,
                                "nscannedObjectsAllPlans" : 9351,
                                "nscannedAllPlans" : 9619,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 104,
                                "indexBounds" : {
                                        "OrderDate" : [
                                                [
                                                        ISODate("2014-01-01T16:00:00Z"),
                                                        ISODate("2015-01-01T16:00:00Z")
                                                ]
                                        ],
                                        "CustomerCode" : [
                                                [
                                                        "C00004",
                                                        "C00004"
                                                ]
                                        ]
                                },
                                "server" : "mongodb02:27017"
                        }
                ]
        },
        "cursor" : "BtreeCursor OrderDate_1_CustomerCode_1",
        "n" : 25185,
        "nChunkSkips" : 0,
        "nYields" : 0,
        "nscanned" : 25913,
        "nscannedAllPlans" : 26121,
        "nscannedObjects" : 25185,
        "nscannedObjectsAllPlans" : 25393,
        "millisShardTotal" : 251,
        "millisShardAvg" : 125,
        "numQueries" : 2,
        "numShards" : 2,
        "millis" : 153
}


从结果观察到，  查询 2014年全年 C00004 的数据
由于 分片是 按照 日期 + 顾客代码 进行分片的
通过查询条件， 可以明确的指定， 数据位于哪些分片上面。
因此， 查询计划中显示， 需要访问  "192.168.253.209:27017" 与  "192.168.253.210:27017"  这个2个分片

"cursor" : "BtreeCursor OrderDate_1_CustomerCode_1"  意味着本查询将使用一个索引。
"n" : 25185  表示返回的文档数量。
"numShards" : 2  表示查询将查询2个片





步骤5.  模拟某个片发生故障了， 如果查询的数据， 不在故障片上的情况。

还是用上面的  2013年11月1日 C00004 的数据 的例子。
查询计划显示， 数据位于 "192.168.253.209:27017"  这个分片上面

首先， 先到  192.168.253.213 机器上， mongod 程序上， 按 Ctrl+C 停止程序运行。

然后，

mongos> db.TestOrder.count();
Fri Oct 11 15:34:32.418 count failed: { "code" : 15988, "ok" : 0, "errmsg" : "ex
ception: error querying server" } at src/mongo/shell/query.js:180
mongos>

mongos> db.TestOrder.find( { "OrderDate" : ISODate("2013-11-01T16:00:00Z"), "CustomerCode" : "C00004"  } ).limit(1);
{ 
  "_id" : ObjectId("5257999170da9a290485e9c8"), 
  "CustomerCode" : "C00004", 
  "OrderDate" : ISODate("2013-11-01T16:00:00Z"), 
  "CustomerName" : "李四", 
  "OrderDetail" : [    
    {  
      "_id" : ObjectId("5257999170da9a290485e954"),   
      "GoodsCode" : "A001",   
      "GoodsName" : "苹果",   
      "GoodsPrice" : 20,      
      "GoodsCount" : 24 
    },
   {
      "_id" : ObjectId("5257999170da9a290485e956"),   
      "GoodsCode" : "A003",
      "GoodsName" : "桔子",   
      "GoodsPrice" : 5,       
      "GoodsCount" : 78 
    },    
    {
      "_id" : ObjectId("5257999170da9a290485e958"),   
      "GoodsCode" : "A005",   
      "GoodsName" : "芒果",   
      "GoodsPrice" : 25,      
      "GoodsCount" : 73 
    } 
  ] 
}
mongos>


结果显示， 当 某个片故障的情况下， 如果查询需要访问到那个故障片， 将报查询错误。
而查询不需要访问故障片的情况下， 将正常返回查询结果。


恢复 192.168.253.213 机器上的  mongod 的运行。




步骤6.  查看最终的数据库状态

mongos> db.stats();
{
        "raw" : {
                "192.168.253.209:27017" : {
                        "db" : "test",
                        "collections" : 5,
                        "objects" : 302223,
                        "avgObjSize" : 200.37879314281176,
                        "dataSize" : 60559080,
                        "storageSize" : 116899840,
                        "numExtents" : 21,
                        "indexes" : 4,
                        "indexSize" : 14038192,
                        "fileSize" : 520093696,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.210:27017" : {
                        "db" : "test",
                        "collections" : 4,
                        "objects" : 82682,
                        "avgObjSize" : 394.61372487361217,
                        "dataSize" : 32627452,
                        "storageSize" : 59150336,
                        "numExtents" : 15,
                        "indexes" : 3,
                        "indexSize" : 6876016,
                        "fileSize" : 251658240,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.211:27017" : {
                        "db" : "test",
                        "collections" : 4,
                        "objects" : 171788,
                        "avgObjSize" : 266.9372715207116,
                        "dataSize" : 45856620,
                        "storageSize" : 58437632,
                        "numExtents" : 16,
                        "indexes" : 3,
                        "indexSize" : 10334464,
                        "fileSize" : 251658240,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.212:27017" : {
                        "db" : "test",
                        "collections" : 4,
                        "objects" : 99181,
                        "avgObjSize" : 428.71739546889023,
                        "dataSize" : 42520620,
                        "storageSize" : 58462208,
                        "numExtents" : 12,
                        "indexes" : 3,
                        "indexSize" : 8094240,
                        "fileSize" : 251658240,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                },
                "192.168.253.213:27017" : {
                        "db" : "test",
                        "collections" : 4,
                        "objects" : 344179,
                        "avgObjSize" : 164.67992527144307,
                        "dataSize" : 56679372,
                        "storageSize" : 80961536,
                        "numExtents" : 18,
                        "indexes" : 3,
                        "indexSize" : 21184016,
                        "fileSize" : 520093696,
                        "nsSizeMB" : 16,
                        "dataFileVersion" : {
                                "major" : 4,
                                "minor" : 5
                        },
                        "ok" : 1
                }
        },
        "objects" : 1000053,
        "avgObjSize" : 237.599147245196,
        "dataSize" : 238243144,
        "storageSize" : 373911552,
        "numExtents" : 82,
        "indexes" : 16,
        "indexSize" : 60526928,
        "fileSize" : 1795162112,
        "ok" : 1
}


注：由于数据库中的配置中：
mongos> db.databases.find();
{ "_id" : "admin", "partitioned" : false, "primary" : "config" }
{ "_id" : "test", "partitioned" : true, "primary" : "Basic Shard Server" }

test 数据库的  primary 是   "Basic Shard Server" 
对于某些 不参加分片的文档， 例如本例子的  TestGoods ，只有几行数据，完全没有分片的意义。
因此这个文档就被存储到   "Basic Shard Server"   这个服务器上面。

建议服务器环境首次搭建的时候， primary  的数据库，搭建为 “主从复制”，  或者 “副本集” 的方式。



步骤7.  将  "Basic Shard Server" 数据库切换为 主从复制的模式


首先 在 192.168.253.209 的 mongod 进程上面， 按 Ctrl+C ， 停掉服务。
修改参数，重新运行
mongod.exe  --dbpath  D:\data\db --master
启动 mongo 服务器端程序 (主)


由于已经开了5个虚拟机了， 为了简单测试一下 主从， 就不额外再创建一个虚拟机了。
从节点就直接与主节点放一台虚拟机里面。修改一下数据目录，与端口。
在 192.168.253.209  上面运行
mkdir -p  /data/sdb2
创建用于存储数据库文件的目录

运行
./mongod --dbpath  /data/sdb2  --port 27018 --slave
启动 mongo 服务器端程序 (从)


运行 
mongo 192.168.253.209:27018
登录到 从的服务器上面

运行
> use local
switched to db local

> db.sources.insert( { "host" : "192.168.253.209:27017" } );
>
> db.sources.find();
{ "_id" : ObjectId("5257bf8761d9b2454a3220c4"), "host" : "192.168.253.209:27017"
, "source" : "main", "syncedTo" : Timestamp(1381482380, 1) }
>
> use test
switched to db test
>
> db.TestGoods.find();
{ "_id" : ObjectId("5257999170da9a290485e954"), "GoodsCode" : "A001", "GoodsName
" : "苹果", "GoodsPrice" : 20 }
{ "_id" : ObjectId("5257999170da9a290485e955"), "GoodsCode" : "A002", "GoodsName
" : "梨子", "GoodsPrice" : 10 }
{ "_id" : ObjectId("5257999170da9a290485e956"), "GoodsCode" : "A003", "GoodsName
" : "桔子", "GoodsPrice" : 5 }
{ "_id" : ObjectId("5257999170da9a290485e957"), "GoodsCode" : "A004", "GoodsName
" : "葡萄", "GoodsPrice" : 15 }
{ "_id" : ObjectId("5257999170da9a290485e958"), "GoodsCode" : "A005", "GoodsName
" : "芒果", "GoodsPrice" : 25 }
>

> db.stats();
{
        "db" : "test",
        "collections" : 5,
        "objects" : 302223,
        "avgObjSize" : 200.37879314281176,
        "dataSize" : 60559080,
        "storageSize" : 96256000,
        "numExtents" : 20,
        "indexes" : 4,
        "indexSize" : 12035072,
        "fileSize" : 520093696,
        "nsSizeMB" : 16,
        "dataFileVersion" : {
                "major" : 4,
                "minor" : 5
        },
        "ok" : 1
}

结果显示， 主数据库中的数据， 已经被同步到从数据库上面了。









</code></pre>
    </td>
  </tr>


</table>




</body>


</html>
